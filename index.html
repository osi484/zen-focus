<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="description" content="Zen Focus: 전 세계 유저를 위한 미니멀 백색소음 타이머와 투두리스트. Minimalist white noise timer and todo list for global users.">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3239/3239147.png">
    <title>Zen Focus | 집중을 위한 공간</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .ad-placeholder {
            background: rgba(30, 41, 59, 0.3);
            border: 1px dashed rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.1);
            font-size: 9px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            border-radius: 1rem;
        }
        input::placeholder { color: rgba(255, 255, 255, 0.3); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        
        /* Smooth scrolling for mobile keyboard */
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6 md:p-8">

    <!-- Google AdSense Global Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1337800001968718"
     crossorigin="anonymous"></script>

    <!-- Language Toggle (Bottom Right) -->
    <div class="fixed bottom-6 right-6 md:bottom-8 md:right-8 z-50">
        <button id="lang-toggle" class="glass px-5 py-3 md:px-4 md:py-2 rounded-full text-[11px] md:text-[10px] tracking-[0.2em] text-slate-500 hover:text-slate-200 transition-all uppercase font-light border border-slate-800/50 hover:border-slate-700 shadow-xl">
            <span id="lang-ko" class="transition-all">KO</span>
            <span class="mx-2 text-slate-800">/</span>
            <span id="lang-en" class="transition-all">EN</span>
        </button>
    </div>

    <div class="max-w-5xl w-full flex flex-col items-center gap-10 md:gap-12 my-8 md:my-12">
        <header class="text-center space-y-5">
            <h1 class="text-3xl md:text-4xl font-extralight tracking-[0.3em] text-slate-100 uppercase">Zen Focus</h1>
            <div id="stats-display" class="text-[10px] md:text-xs text-slate-500 tracking-widest uppercase bg-slate-800/30 py-2.5 px-5 rounded-full inline-block">
                <span data-i18n="todayFocus">오늘 나의 집중:</span> <span id="focus-minutes" class="text-slate-300 font-semibold">0</span><span data-i18n="minUnit">분</span>
            </div>
        </header>

        <!-- Quote & Tip Area -->
        <div class="w-full max-w-2xl glass py-4 px-6 rounded-2xl text-center flex items-center justify-center gap-3 group border-slate-800/30 hover:border-slate-700 transition-all duration-500 overflow-hidden" id="quote-area">
            <span class="text-[9px] text-slate-500 uppercase tracking-widest font-semibold border border-slate-700 px-2 py-0.5 rounded-md group-hover:text-slate-300 transition-colors">TIP & QUOTE</span>
            <p id="focus-tip-text" class="text-xs md:text-sm font-light text-slate-400 group-hover:text-slate-200 transition-colors truncate italic"></p>
        </div>

        <div class="w-full flex flex-col lg:flex-row gap-8 items-start justify-center">
            
            <main class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10 items-start max-w-4xl w-full">
                <!-- Timer Section -->
                <section class="glass p-8 md:p-10 rounded-[2rem] md:rounded-[2.5rem] shadow-2xl text-center space-y-8 md:space-y-10 order-1">
                    <div class="space-y-3">
                        <div id="timer-display" class="text-7xl md:text-8xl font-thin tracking-tighter text-slate-100 transition-all duration-500">25:00</div>
                        <div id="timer-label" data-i18n="focusMode" class="text-[10px] text-slate-500 uppercase tracking-[0.4em]">Focus Mode</div>
                    </div>

                    <div class="flex items-center justify-center gap-4 py-2">
                        <input type="number" id="minutes-input" value="25" min="1" max="999" 
                            class="w-20 md:w-24 bg-transparent border-b border-slate-700 text-center text-3xl font-light focus:outline-none focus:border-slate-400 transition-colors py-2">
                        <span data-i18n="minUnitLabel" class="text-slate-500 font-light">min</span>
                    </div>

                    <div class="flex flex-col gap-4">
                        <button id="start-btn" data-i18n="start" class="w-full bg-slate-100 text-slate-900 font-medium py-5 md:py-5 rounded-2xl hover:bg-white transition-all active:scale-[0.96] tracking-widest text-sm uppercase shadow-lg">START</button>
                        <button id="reset-btn" data-i18n="reset" class="w-full bg-transparent text-slate-500 hover:text-slate-300 py-3 rounded-2xl transition-all text-[10px] tracking-widest uppercase active:scale-95">RESET TIMER</button>
                    </div>

                    <div class="pt-8 border-t border-slate-800/50 space-y-6">
                        <div class="flex flex-col gap-3">
                            <div class="flex items-center justify-between">
                                <span data-i18n="volume" class="text-[10px] text-slate-500 uppercase tracking-widest">Volume</span>
                            </div>
                            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3" 
                                class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-slate-400">
                        </div>
                        <div class="flex items-center justify-between">
                            <span data-i18n="soundscape" class="text-[10px] text-slate-500 uppercase tracking-widest">Soundscape</span>
                            <select id="sound-select" class="bg-transparent text-xs text-slate-400 focus:outline-none cursor-pointer text-right hover:text-slate-200 transition-colors py-1">
                                <option value="assets/rain.mp3" data-i18n="soundRain">Soft Rain</option>
                                <option value="assets/Ambience.mp3" data-i18n="soundForest">Deep Forest</option>
                                <option value="assets/Campfire.mp3" data-i18n="soundCampfire">Crackling Campfire</option>
                                <option value="assets/Ocean Waves.mp3" data-i18n="soundOcean">Gentle Ocean</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Tasks Section -->
                <section class="glass p-8 md:p-8 rounded-[2rem] md:rounded-[2.5rem] shadow-xl space-y-6 order-2 flex flex-col">
                    <div class="flex items-center justify-between px-2">
                        <h2 data-i18n="rituals" class="text-[10px] font-semibold text-slate-500 uppercase tracking-[0.3em]">Daily Rituals</h2>
                        <button id="clear-completed-btn" data-i18n="clearCompleted" class="text-[9px] text-slate-600 hover:text-red-400 transition-colors uppercase tracking-widest py-2">Clear Completed</button>
                    </div>
                    
                    <div class="relative group">
                        <input type="text" id="todo-input" data-i18n-placeholder="todoPlaceholder" placeholder="오늘의 몰입을 기록하세요..." 
                            class="w-full bg-slate-800/20 border border-slate-800/50 rounded-2xl pl-5 pr-14 py-4.5 md:py-4 focus:outline-none focus:border-slate-600 transition-all text-sm placeholder:text-slate-600 h-14">
                        <button id="add-todo-btn" class="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-slate-800 rounded-xl flex items-center justify-center hover:bg-slate-700 transition-colors text-slate-400">+</button>
                    </div>

                    <ul id="todo-list" class="space-y-4 max-h-[340px] md:max-h-[340px] overflow-y-auto pr-1 custom-scrollbar flex-1"></ul>

                    <!-- Bottom Ad Slot (ad-slot-1) -->
                    <div class="mt-4 ad-placeholder h-20 w-full" id="ad-slot-1">
                        <!-- AdSense Code Here -->
                        ADVERTISEMENT
                    </div>
                </section>
            </main>

            <!-- Sidebar Ad Slot (ad-slot-2) -->
            <aside class="hidden lg:flex flex-col gap-6">
                <div class="ad-placeholder w-[160px] h-[600px]" id="ad-slot-2">
                    <!-- AdSense Code Here -->
                    ADVERTISEMENT
                </div>
            </aside>
        </div>

        <footer class="text-center text-slate-700 text-[9px] tracking-[0.2em] space-y-4 pt-8 pb-12 md:pb-0">
            <div class="uppercase">&copy; 2024 Zen Focus. <span data-i18n="footerSub">Minimalist Flow Tool.</span></div>
            <div class="opacity-40 italic leading-loose px-4 md:px-0" data-i18n="footerAttribution">본 서비스의 음원은 공유마당의 자유이용 저작물을 활용하였습니다.</div>
            <div class="pt-2 flex justify-center gap-6 opacity-50">
                <button onclick="openModal('privacy')" class="uppercase border-b border-transparent hover:border-slate-500 hover:text-slate-300 transition-all pb-0.5">Privacy Policy</button>
                <button onclick="openModal('contact')" class="uppercase border-b border-transparent hover:border-slate-500 hover:text-slate-300 transition-all pb-0.5">Contact</button>
            </div>
        </footer>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 opacity-0 pointer-events-none transition-all duration-500">
        <div class="absolute inset-0 bg-slate-950/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="glass max-w-lg w-full max-h-[80vh] overflow-y-auto p-8 md:p-10 rounded-[2.5rem] relative shadow-2xl custom-scrollbar">
            <button onclick="closeModal()" class="absolute top-6 right-8 text-2xl text-slate-500 hover:text-slate-200 transition-colors">&times;</button>
            <div id="modal-content" class="space-y-6 text-sm font-light leading-relaxed text-slate-300">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Notification Popup -->
    <div id="finish-popup" class="fixed bottom-10 left-1/2 -translate-x-1/2 glass px-8 py-4 rounded-2xl shadow-2xl border-slate-500/20 transform translate-y-32 opacity-0 transition-all duration-700 flex items-center gap-4 z-50">
        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
        <p id="popup-text" class="text-sm text-slate-200 font-light" data-i18n="popupMessage">고생하셨습니다! 잠시 휴식하세요. ✨</p>
    </div>

    <audio id="bg-audio" loop preload="auto"></audio>

    <!-- Build Trigger: Updated with zen-focus rename 2026-02-23 -->
    <script>
        const LANG_PACKAGE = {
            ko: {
                todayFocus: "오늘 나의 집중: ",
                minUnit: "분",
                minUnitLabel: "min",
                focusMode: "Focus Mode",
                start: "START",
                pause: "PAUSE",
                resume: "RESUME",
                reset: "RESET TIMER",
                volume: "Volume",
                soundscape: "Soundscape",
                soundRain: "Soft Rain",
                soundForest: "Deep Forest",
                soundCampfire: "Crackling Campfire",
                soundOcean: "Gentle Ocean",
                rituals: "Daily Rituals",
                clearCompleted: "Clear Completed",
                todoPlaceholder: "오늘의 몰입을 기록하세요...",
                footerSub: "Minimalist Flow Tool.",
                footerAttribution: "본 서비스의 음원은 공유마당의 자유이용 저작물을 활용하였습니다.",
                popupMessage: "고생하셨습니다! 잠시 휴식하세요. ✨",
                notificationBody: "고생하셨습니다! 잠시 휴식하세요."
            },
            en: {
                todayFocus: "Today's Focus: ",
                minUnit: " min",
                minUnitLabel: "min",
                focusMode: "Focus Mode",
                start: "START",
                pause: "PAUSE",
                resume: "RESUME",
                reset: "RESET TIMER",
                volume: "Volume",
                soundscape: "Soundscape",
                soundRain: "Soft Rain",
                soundForest: "Deep Forest",
                soundCampfire: "Crackling Campfire",
                soundOcean: "Gentle Ocean",
                rituals: "Daily Rituals",
                clearCompleted: "Clear Completed",
                todoPlaceholder: "Record today's flow...",
                footerSub: "Minimalist Flow Tool.",
                footerAttribution: "Audio assets provided by Gong-yu Madang (Open License).",
                popupMessage: "Well done! Take a break. ✨",
                notificationBody: "Well done! Take a break."
            }
        };

        const timerDisplay = document.getElementById('timer-display');
        const minutesInput = document.getElementById('minutes-input');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const soundSelect = document.getElementById('sound-select');
        const volumeSlider = document.getElementById('volume-slider');
        const bgAudio = document.getElementById('bg-audio');
        const todoInput = document.getElementById('todo-input');
        const addTodoBtn = document.getElementById('add-todo-btn');
        const todoList = document.getElementById('todo-list');
        const clearCompletedBtn = document.getElementById('clear-completed-btn');
        const focusMinutesDisplay = document.getElementById('focus-minutes');
        const finishPopup = document.getElementById('finish-popup');
        const langToggle = document.getElementById('lang-toggle');
        const infoModal = document.getElementById('info-modal');
        const modalContent = document.getElementById('modal-content');
        const focusTipText = document.getElementById('focus-tip-text');

        // Focus Tips & Quotes Data
        const FOCUS_TIPS = {
            ko: [
                "휴대폰을 다른 방에 두는 것만으로도 집중력이 올라갑니다.",
                "뽀모도로 기법(25분 집중, 5분 휴식)을 사용해 보세요.",
                "주변을 정리하면 뇌의 인지 부하가 줄어듭니다.",
                "멀티태스킹은 집중력의 가장 큰 적입니다.",
                "심호흡 3번으로 몰입을 시작해 보세요.",
                "\"성공은 당신이 얼마나 집중할 수 있느냐에 달려 있다.\"",
                "\"집중력은 지능보다 더 강력한 무기이다.\"",
                "\"당신의 마음이 머무는 곳에 당신의 에너지가 흐른다.\"",
                "\"몰입은 행복으로 가는 가장 빠른 길입니다.\"",
                "\"작은 일에 집중하는 것이 위대한 일을 이루는 시작이다.\"",
                "한 번에 오직 한 가지 일에만 몰입하세요.",
                "잠깐의 스트레칭은 뇌에 산소를 공급해 줍니다."
            ],
            en: [
                "Keeping your phone in another room boosts concentration.",
                "Try the Pomodoro technique (25m focus, 5m rest).",
                "Decluttering your space reduces cognitive load on the brain.",
                "Multitasking is the biggest enemy of deep focus.",
                "Start your flow with three deep breaths.",
                "\"Success is the result of your ability to focus.\"",
                "\"Focus is a more powerful weapon than intelligence.\"",
                "\"Where your mind goes, your energy flows.\"",
                "\"Flow is the fastest path to happiness.\"",
                "\"Focusing on small tasks is the start of achieving greatness.\"",
                "Immerse yourself in only one task at a time.",
                "Short stretching supplies oxygen to your brain."
            ]
        };

        let currentTipIndex = Math.floor(Math.random() * FOCUS_TIPS.ko.length);

        function updateFocusTip() {
            focusTipText.textContent = FOCUS_TIPS[currentLang][currentTipIndex];
        }

        // Modal Content Data
        const modalData = {
            privacy: {
                ko: `<h3 class="text-lg text-slate-100 uppercase tracking-widest font-normal border-b border-slate-800 pb-4">개인정보 처리방침</h3>
                     <div class="space-y-4 py-2">
                        <section>
                            <h4 class="text-slate-200 font-medium mb-1">1. 데이터 수집 및 저장</h4>
                            <p>Zen Focus는 서버에 어떠한 개인정보도 수집하거나 저장하지 않습니다. 모든 서비스 데이터(할 일 목록, 통계 등)는 브라우저의 <span class="text-slate-100">로컬 스토리지(Local Storage)</span>에만 저장되어 사용자의 기기를 떠나지 않습니다.</p>
                        </section>
                        <section>
                            <h4 class="text-slate-200 font-medium mb-1">2. 쿠키 및 광고 서비스</h4>
                            <p>Google AdSense를 포함한 제3자 제공업체는 쿠키를 사용하여 사용자의 이전 방문 기록을 바탕으로 맞춤형 광고를 제공합니다. 구글의 광고 쿠키 사용을 통해 사용자가 본 사이트 및 다른 사이트를 방문할 때 적절한 광고를 게재할 수 있습니다.</p>
                        </section>
                        <section>
                            <h4 class="text-slate-200 font-medium mb-1">3. 사용자 선택권</h4>
                            <p>사용자는 <a href="https://www.google.com/settings/ads" target="_blank" class="text-blue-400 underline">구글 광고 설정</a> 페이지를 통해 맞춤형 광고를 해제할 수 있습니다. 또한 브라우저 설정을 통해 모든 쿠키를 거부하거나 로컬 데이터를 삭제할 수 있습니다.</p>
                        </section>
                     </div>`,
                en: `<h3 class="text-lg text-slate-100 uppercase tracking-widest font-normal border-b border-slate-800 pb-4">Privacy Policy</h3>
                     <div class="space-y-4 py-2">
                        <section>
                            <h4 class="text-slate-200 font-medium mb-1">1. Data Collection & Storage</h4>
                            <p>Zen Focus does not collect or store any personal data on servers. All service data (todos, stats, etc.) is stored exclusively in your browser's <span class="text-slate-100">Local Storage</span>, meaning it never leaves your device.</p>
                        </section>
                        <section>
                            <h4 class="text-slate-200 font-medium mb-1">2. Cookies & Advertising</h4>
                            <p>Third-party vendors, including Google, use cookies to serve ads based on a user's prior visits to this website or other websites. Google's use of advertising cookies enables it and its partners to serve ads to users based on their visit to your sites and/or other sites on the Internet.</p>
                        </section>
                        <section>
                            <h4 class="text-slate-200 font-medium mb-1">3. User Choices</h4>
                            <p>Users may opt out of personalized advertising by visiting <a href="https://www.google.com/settings/ads" target="_blank" class="text-blue-400 underline">Ads Settings</a>. You can also manage or delete cookies and local storage data via your browser settings.</p>
                        </section>
                     </div>`
            },
            contact: {
                ko: `<h3 class="text-lg text-slate-100 uppercase tracking-widest font-normal border-b border-slate-800 pb-4">문의하기</h3>
                     <p>서비스 이용 중 불편한 점이나 제안 사항이 있다면 아래 이메일로 연락주세요.</p>
                     <p class="text-slate-100 font-medium">Email: support@zenfocus.example</p>
                     <p class="text-[10px] text-slate-500 mt-4 italic">최대한 빠른 시일 내에 답변 드리겠습니다.</p>`,
                en: `<h3 class="text-lg text-slate-100 uppercase tracking-widest font-normal border-b border-slate-800 pb-4">Contact</h3>
                     <p>If you have any feedback or inquiries, please feel free to reach out via email.</p>
                     <p class="text-slate-100 font-medium">Email: support@zenfocus.example</p>
                     <p class="text-[10px] text-slate-500 mt-4 italic">We will get back to you as soon as possible.</p>`
            }
        };

        window.openModal = (type) => {
            modalContent.innerHTML = modalData[type][currentLang];
            infoModal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.style.overflow = 'hidden';
        };

        window.closeModal = () => {
            infoModal.classList.add('opacity-0', 'pointer-events-none');
            document.body.style.overflow = '';
        };

        // Language Logic
        let currentLang = localStorage.getItem('zen-lang') || 
            (window.navigator.language.startsWith('ko') ? 'ko' : 'en');

        function applyTranslations() {
            const t = LANG_PACKAGE[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });
            
            // Update buttons state
            if (isRunning) {
                startBtn.textContent = t.pause;
            } else if (timeLeft < originalTime) {
                startBtn.textContent = t.resume;
            } else {
                startBtn.textContent = t.start;
            }

            // Update toggle visual
            document.getElementById('lang-ko').classList.toggle('text-slate-100', currentLang === 'ko');
            document.getElementById('lang-ko').classList.toggle('font-medium', currentLang === 'ko');
            document.getElementById('lang-en').classList.toggle('text-slate-100', currentLang === 'en');
            document.getElementById('lang-en').classList.toggle('font-medium', currentLang === 'en');
        }

        langToggle.onclick = () => {
            currentLang = currentLang === 'ko' ? 'en' : 'ko';
            localStorage.setItem('zen-lang', currentLang);
            applyTranslations();
            updateFocusTip();
            renderTodos();
        };

        // Stats Logic
        let totalFocusMinutes = parseInt(localStorage.getItem('zen-focus-total')) || 0;
        function updateStats(mins) {
            totalFocusMinutes += mins;
            localStorage.setItem('zen-focus-total', totalFocusMinutes);
            focusMinutesDisplay.textContent = totalFocusMinutes;
        }
        focusMinutesDisplay.textContent = totalFocusMinutes;

        // Notification Logic
        function showNotification() {
            finishPopup.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => {
                finishPopup.classList.add('translate-y-32', 'opacity-0');
            }, 5000);
            
            if (Notification.permission === "granted") {
                new Notification("Zen Focus", { 
                    body: LANG_PACKAGE[currentLang].notificationBody, 
                    icon: "/favicon.ico" 
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        // 초기 볼륨 설정
        bgAudio.volume = 0.3;

        let timeLeft = 25 * 60;
        let originalTime = 25 * 60;
        let timerInterval = null;
        let isRunning = false;

        function updateDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            const timeStr = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            timerDisplay.textContent = timeStr;
            
            if (isRunning) {
                document.title = `(${timeStr}) Zen Focus`;
            } else {
                document.title = `Zen Focus`;
            }
        }

        async function playAudio() {
            try {
                if (bgAudio.src !== window.location.origin + '/' + soundSelect.value && !bgAudio.src.endsWith(soundSelect.value)) {
                    bgAudio.src = soundSelect.value;
                    bgAudio.load();
                }
                await bgAudio.play();
            } catch (e) {
                console.error("Audio error:", e);
            }
        }

        function startTimer() {
            if (isRunning) {
                pauseTimer();
                return;
            }

            isRunning = true;
            originalTime = minutesInput.value * 60;
            startBtn.textContent = LANG_PACKAGE[currentLang].pause;
            startBtn.classList.replace('bg-slate-100', 'bg-slate-800');
            startBtn.classList.replace('text-slate-900', 'text-slate-100');
            
            playAudio();

            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateDisplay();
                } else {
                    const completedMins = Math.floor(originalTime / 60);
                    updateStats(completedMins);
                    stopTimer(true);
                }
            }, 1000);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            startBtn.textContent = LANG_PACKAGE[currentLang].resume;
            startBtn.classList.replace('bg-slate-800', 'bg-slate-100');
            startBtn.classList.replace('text-slate-100', 'text-slate-900');
            bgAudio.pause();
            updateDisplay();
        }

        function stopTimer(finished = false) {
            isRunning = false;
            clearInterval(timerInterval);
            bgAudio.pause();
            updateDisplay();
            
            if (finished) {
                showNotification();
                resetTimer();
            }
        }

        function resetTimer() {
            stopTimer();
            timeLeft = minutesInput.value * 60;
            updateDisplay();
            startBtn.textContent = LANG_PACKAGE[currentLang].start;
            startBtn.classList.remove('bg-slate-800', 'text-slate-100');
            startBtn.classList.add('bg-slate-100', 'text-slate-900');
        }

        // Todo Logic
        let todos = JSON.parse(localStorage.getItem('zen-todos')) || [];
        function saveTodos() { localStorage.setItem('zen-todos', JSON.stringify(todos)); }
        function renderTodos() {
            todoList.innerHTML = '';
            const sortedTodos = [...todos].sort((a, b) => a.completed - b.completed);
            
            sortedTodos.forEach((todo, index) => {
                const originalIndex = todos.indexOf(todo);
                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-4.5 md:p-4 rounded-2xl bg-slate-800/10 border border-slate-800/30 group hover:border-slate-700 transition-all ${todo.completed ? 'opacity-60' : ''}`;
                li.innerHTML = `
                    <div class="flex items-center gap-4 flex-1 cursor-pointer py-1" onclick="toggleTodo(${originalIndex})">
                        <div class="w-6 h-6 md:w-5 md:h-5 rounded-full border border-slate-600 flex items-center justify-center transition-all ${todo.completed ? 'bg-slate-400 border-slate-400' : 'group-hover:border-slate-400'}">
                            ${todo.completed ? '<svg class="w-3.5 h-3.5 md:w-3 md:h-3 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                        </div>
                        <span class="text-[15px] md:text-sm font-light transition-all ${todo.completed ? 'line-through text-slate-500' : 'text-slate-300'}">${todo.text}</span>
                    </div>
                    <button onclick="removeTodo(${originalIndex})" class="text-slate-700 hover:text-red-400 opacity-100 md:opacity-0 group-hover:opacity-100 transition-all px-3 py-2 text-xl md:text-base leading-none">&times;</button>
                `;
                todoList.appendChild(li);
            });
        }

        window.toggleTodo = (index) => { todos[index].completed = !todos[index].completed; saveTodos(); renderTodos(); };
        window.removeTodo = (index) => { todos = todos.filter((_, i) => i !== index); saveTodos(); renderTodos(); };
        
        clearCompletedBtn.onclick = () => {
            todos = todos.filter(t => !t.completed);
            saveTodos();
            renderTodos();
        };

        addTodoBtn.onclick = () => {
            const text = todoInput.value.trim();
            if (text) { todos.push({ text, completed: false }); todoInput.value = ''; saveTodos(); renderTodos(); }
        };
        todoInput.onkeypress = (e) => { if (e.key === 'Enter') addTodoBtn.click(); };

        minutesInput.onchange = () => { if (!isRunning) { timeLeft = minutesInput.value * 60; updateDisplay(); } };
        startBtn.onclick = startTimer;
        resetBtn.onclick = resetTimer;
        soundSelect.onchange = () => { if (isRunning) { playAudio(); } };
        volumeSlider.oninput = (e) => { bgAudio.volume = e.target.value; };

        // Request Notification Permission
        if (Notification.permission === "default") {
            Notification.requestPermission();
        }

        applyTranslations();
        updateFocusTip();
        renderTodos();
        updateDisplay();

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW error', err));
            });
        }
    </script>
</body>
</html>
